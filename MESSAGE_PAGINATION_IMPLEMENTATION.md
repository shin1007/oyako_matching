# メッセージAPIページネーション実装

## 概要

メッセージ詳細API (`/api/messages/[id]`) に対してページネーション機能を実装しました。これにより、大量のメッセージを含むスレッドでも効率的にデータを取得できるようになります。

## 変更内容

### 1. API エンドポイント (`/app/api/messages/[id]/route.ts`)

#### クエリパラメータ

| パラメータ | 型 | デフォルト値 | 説明 |
|-----------|-----|------------|------|
| `limit` | number | 50 | 1ページあたりの取得件数（最大100件に制限） |
| `offset` | number | 0 | 取得開始位置のオフセット |
| `sort` | 'asc' \| 'desc' | 'desc' | ソート順序（asc: 昇順, desc: 降順） |

#### パラメータのバリデーション

- **limit**: 
  - 正の整数のみ受け付け
  - 100件を超える値は100に制限される
  - 無効な値の場合はデフォルト値（50）を使用

- **offset**:
  - 0以上の整数のみ受け付け
  - 負の値の場合はデフォルト値（0）を使用

- **sort**:
  - 'asc' または 'desc' のみ受け付け
  - その他の値の場合はデフォルト値（'desc'）を使用

#### レスポンス形式

```typescript
{
  match: {
    // マッチ情報
  },
  messages: Message[], // ページネーションされたメッセージリスト
  pagination: {
    total: number,      // 総メッセージ数
    limit: number,      // 1ページあたりの件数
    offset: number,     // 現在のオフセット
    hasMore: boolean    // 次のページが存在するか
  }
}
```

### 2. フロントエンド (`/app/messages/[id]/page.tsx`)

#### 主な変更点

1. **初期読み込み**
   - 最新50件のメッセージを降順で取得
   - 取得後、昇順に並び替えて表示（新しいメッセージが下に表示）

2. **「古いメッセージを読み込む」ボタン**
   - メッセージリストの上部に表示
   - クリックすると次の50件（古いメッセージ）を取得
   - 取得したメッセージは既存のメッセージの前に追加

3. **リアルタイム購読**
   - 新規メッセージの購読機能は維持
   - 新しいメッセージが送信されるとリストの最後に追加

#### 新規インターフェース

```typescript
interface PaginationInfo {
  total: number;
  limit: number;
  offset: number;
  hasMore: boolean;
}
```

#### 新規ステート

```typescript
const [pagination, setPagination] = useState<PaginationInfo | null>(null);
const [loadingMore, setLoadingMore] = useState(false);
```

## 使用例

### API直接呼び出し

```bash
# 初回読み込み（最新50件）
GET /api/messages/[match-id]?limit=50&sort=desc

# 2ページ目（51-100件目）
GET /api/messages/[match-id]?limit=50&offset=50&sort=desc

# 3ページ目（101-150件目）
GET /api/messages/[match-id]?limit=50&offset=100&sort=desc

# 昇順で取得（古い順）
GET /api/messages/[match-id]?limit=50&sort=asc
```

### フロントエンドでの使用

フロントエンドでは自動的にページネーションが適用されます：

1. ページを開くと最新50件が表示される
2. 上部の「古いメッセージを読み込む」ボタンをクリックで追加読み込み
3. すべてのメッセージを読み込むとボタンが非表示になる

## パフォーマンス改善

### 変更前

- すべてのメッセージを一度に取得
- 大量のメッセージがある場合、応答時間が長くなる
- メモリ使用量が増大

### 変更後

- デフォルトで50件のみ取得
- 最大100件までに制限
- 必要に応じて段階的に読み込み
- 初期ロード時間の短縮
- メモリ使用量の削減

## 互換性

### 後方互換性

パラメータを指定しない場合でもページネーションが適用されます：

```bash
# パラメータなしの場合
GET /api/messages/[match-id]
# ↓ 以下と同じ動作
GET /api/messages/[match-id]?limit=50&offset=0&sort=desc
```

### 既存機能への影響

以下の機能は変更なく動作します：

- ✅ メッセージ送信
- ✅ 既読機能
- ✅ リアルタイムメッセージ購読
- ✅ メッセージ一覧表示

## テスト

### 動作確認項目

- [ ] デフォルトパラメータで50件取得できる
- [ ] limitを指定して任意の件数を取得できる
- [ ] limitが100を超える場合、100件に制限される
- [ ] offsetを指定してページング動作する
- [ ] sort=ascで昇順、sort=descで降順に取得できる
- [ ] paginationメタデータが正確に返される
- [ ] hasMoreフラグが正しく設定される
- [ ] フロントエンドで「古いメッセージを読み込む」ボタンが表示される
- [ ] ボタンクリックで古いメッセージが追加読み込みされる
- [ ] すべて読み込むとボタンが非表示になる
- [ ] 新規メッセージ送信が正常に動作する
- [ ] リアルタイム購読が正常に動作する

## セキュリティ

以下のセキュリティチェックは維持されています：

- ✅ ユーザー認証の確認
- ✅ マッチの所有権確認
- ✅ マッチのステータス確認（accepted のみ）
- ✅ パラメータのバリデーション

## 今後の改善案

1. **カーソルベースのページネーション**
   - 現在はoffsetベースだが、カーソルベースに変更することでより効率的に

2. **仮想スクロール**
   - 大量のメッセージがある場合、仮想スクロールで表示パフォーマンスを向上

3. **キャッシュ機構**
   - 一度取得したメッセージをキャッシュして再取得を防ぐ

4. **無限スクロール**
   - ボタンクリックではなく、スクロールで自動読み込み
