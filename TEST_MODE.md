# テストモード設定ガイド

## 概要

開発環境でのテストを容易にするため、マイナンバー認証とサブスクリプション決済をバイパスできるテストモードを実装しました。

## ⚠️ 重要な注意事項

**このテストモードは開発環境（`NODE_ENV=development`）でのみ動作します。**

本番環境（`NODE_ENV=production`）では、`ENABLE_TEST_MODE`が`true`に設定されていても無効化され、通常の認証・認可フローが適用されます。

## 設定方法

### 1. 環境変数の設定

`.env.local`ファイルまたは`.env`ファイルに以下の環境変数を追加してください：

```bash
# テストモードを有効化（開発環境のみ）
ENABLE_TEST_MODE=true
```

### 2. 開発サーバーの起動

```bash
npm run dev
```

## テストモードで可能になること

テストモードが有効な場合、以下の制限が解除されます：

### ✅ マッチング機能（`/matching`）

- **マイナンバー認証なし**でアクセス可能
- **サブスクリプション（親ユーザー）なし**でアクセス可能
- マッチング候補の閲覧が可能
- マッチングの申請が可能

### ✅ メッセージ機能（`/messages`）

- **マイナンバー認証なし**でアクセス可能
- マッチング一覧の閲覧が可能
- マッチングの承認・拒否が可能

### 🔒 依然として必要なこと

テストモードでも以下は必須です：

- ユーザー登録（メールアドレス + パスワード）
- ログイン（認証済みユーザーである必要があります）
- プロフィール情報の登録（マッチングアルゴリズムに必要）

## テストモードの無効化

テストモードを無効にするには、以下のいずれかを行ってください：

### 方法1: 環境変数を削除または変更

```bash
# .env.local または .env から削除
# または
ENABLE_TEST_MODE=false
```

### 方法2: 本番環境で実行

本番環境（`NODE_ENV=production`）で実行すると、自動的にテストモードは無効化されます。

## 実装の詳細

### 影響を受けるAPIルート

1. **`/api/matching/search`**
   - `verification_status`チェックをバイパス
   - サブスクリプションチェックをバイパス

2. **`/api/matching/create`**
   - サブスクリプションチェックをバイパス

### コード例

```typescript
// テストモードチェック（開発環境のみ有効）
const isTestMode = process.env.NODE_ENV === 'development' && 
                   process.env.ENABLE_TEST_MODE === 'true';

// 本人確認チェック（テストモードではスキップ）
if (!isTestMode && userData.verification_status !== 'verified') {
  return NextResponse.json(
    { error: '本人確認が必要です' },
    { status: 403 }
  );
}
```

## セキュリティ上の注意

- **本番環境では絶対にテストモードを有効にしないでください**
- テストモードは開発・デバッグ目的でのみ使用してください
- `.env.local`ファイルはGitにコミットしないでください（`.gitignore`に含まれています）
- `.env.example`にはデフォルト値として`true`が設定されていますが、本番環境では使用されません

## トラブルシューティング

### テストモードが動作しない

1. `NODE_ENV`が`development`に設定されているか確認
   ```bash
   echo $NODE_ENV
   # または package.json の "dev" スクリプトを確認
   ```

2. `.env.local`または`.env`に`ENABLE_TEST_MODE=true`が設定されているか確認

3. 開発サーバーを再起動
   ```bash
   # サーバーを停止して再起動
   npm run dev
   ```

### 依然として認証エラーが発生する

- ログインしているか確認してください（テストモードでもログインは必須です）
- プロフィール情報が登録されているか確認してください

## 関連ファイル

- `.env.example` - 環境変数のテンプレート
- `app/api/matching/search/route.ts` - マッチング検索API
- `app/api/matching/create/route.ts` - マッチング作成API
- `TEST_MODE.md` - このドキュメント
