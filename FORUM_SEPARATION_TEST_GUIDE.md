# フォーラム親子分離機能のテストガイド

## 前提条件

1. データベースマイグレーション `supabase/migrations/028_add_user_type_to_forum_posts.sql` が適用されていること
2. 親ユーザーアカウントと子ユーザーアカウントが作成されていること

## マイグレーションの適用方法

1. Supabaseダッシュボードにログイン
2. 左メニューから「SQL Editor」を選択
3. 「New Query」をクリック
4. `supabase/migrations/028_add_user_type_to_forum_posts.sql`の内容をコピー&ペースト
5. 「Run」ボタンをクリックして実行
6. エラーがないことを確認

## テストケース

### 1. 親ユーザーとしてのテスト

#### 1.1 親フォーラムの閲覧
- [ ] `/forum/parent` にアクセス
- [ ] 親の投稿のみが表示されることを確認
- [ ] 子の投稿が表示されないことを確認

#### 1.2 親フォーラムでの投稿作成
- [ ] 「新規投稿」ボタンをクリック
- [ ] タイトルと本文を入力
- [ ] カテゴリを選択（任意）
- [ ] 「投稿する」ボタンをクリック
- [ ] `/forum/parent` にリダイレクトされることを確認
- [ ] 作成した投稿が一覧に表示されることを確認

#### 1.3 親の投稿へのコメント
- [ ] 親の投稿をクリックして詳細ページに移動
- [ ] コメントフォームが表示されることを確認
- [ ] コメントを入力して送信
- [ ] コメントが正常に投稿されることを確認

#### 1.4 子の投稿へのアクセス制限
- [ ] 子の投稿のURLを直接入力（例: `/forum/[child_post_id]`）
- [ ] エラーメッセージが表示されることを確認
- [ ] `/forum/parent` にリダイレクトされることを確認

### 2. 子ユーザーとしてのテスト

#### 2.1 子フォーラムの閲覧
- [ ] `/forum/child` にアクセス
- [ ] 子の投稿のみが表示されることを確認
- [ ] 親の投稿が表示されないことを確認

#### 2.2 子フォーラムでの投稿作成
- [ ] 「新規投稿」ボタンをクリック
- [ ] タイトルと本文を入力
- [ ] カテゴリを選択（任意）
- [ ] 「投稿する」ボタンをクリック
- [ ] `/forum/child` にリダイレクトされることを確認
- [ ] 作成した投稿が一覧に表示されることを確認

#### 2.3 子の投稿へのコメント
- [ ] 子の投稿をクリックして詳細ページに移動
- [ ] コメントフォームが表示されることを確認
- [ ] コメントを入力して送信
- [ ] コメントが正常に投稿されることを確認

#### 2.4 親の投稿へのアクセス制限
- [ ] 親の投稿のURLを直接入力（例: `/forum/[parent_post_id]`）
- [ ] エラーメッセージが表示されることを確認
- [ ] `/forum/child` にリダイレクトされることを確認

### 3. データベースレベルでの検証

#### 3.1 投稿のuser_type確認
Supabase SQL Editorで以下のクエリを実行：

```sql
-- 親の投稿を確認
SELECT id, title, user_type, author_id
FROM forum_posts
WHERE user_type = 'parent'
LIMIT 5;

-- 子の投稿を確認
SELECT id, title, user_type, author_id
FROM forum_posts
WHERE user_type = 'child'
LIMIT 5;
```

- [ ] 親の投稿に `user_type='parent'` が設定されている
- [ ] 子の投稿に `user_type='child'` が設定されている

#### 3.2 既存投稿のuser_type確認
```sql
-- 既存の投稿がすべて正しいuser_typeを持っているか確認
SELECT fp.id, fp.title, fp.user_type, u.role, fp.author_id
FROM forum_posts fp
JOIN users u ON u.id = fp.author_id
WHERE fp.user_type != u.role;
```

- [ ] 結果が0件であることを確認（すべての投稿のuser_typeが投稿者のroleと一致）

### 4. APIエンドポイントのテスト

#### 4.1 投稿一覧の取得
ブラウザの開発者ツールのNetworkタブで以下を確認：

**親フォーラム**:
```
GET /api/forum/posts?userType=parent
```
- [ ] レスポンスに親の投稿のみが含まれる
- [ ] 子の投稿が含まれない

**子フォーラム**:
```
GET /api/forum/posts?userType=child
```
- [ ] レスポンスに子の投稿のみが含まれる
- [ ] 親の投稿が含まれない

#### 4.2 コメント作成の制限
開発者ツールのConsoleで以下を実行（テストのみ）：

```javascript
// 親ユーザーが子の投稿にコメントしようとする（失敗するはず）
fetch('/api/forum/comments', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    post_id: '[child_post_id]',
    content: 'Test comment'
  })
}).then(r => r.json()).then(console.log);
```

- [ ] 403エラーが返される
- [ ] エラーメッセージが表示される

### 5. UIの検証

#### 5.1 色スキーマ
**親ユーザー**:
- [ ] `/forum/parent` の背景が親カラー（parent-50）
- [ ] ボタンが親カラー（parent-600）
- [ ] 新規投稿ページが親カラー

**子ユーザー**:
- [ ] `/forum/child` の背景が子カラー（child-50）
- [ ] ボタンが子カラー（child-600）
- [ ] 新規投稿ページが子カラー

#### 5.2 ナビゲーション
- [ ] 親ユーザーがダッシュボードから「フォーラム」をクリック → `/forum/parent` に移動
- [ ] 子ユーザーがダッシュボードから「フォーラム」をクリック → `/forum/child` に移動

## トラブルシューティング

### 問題: 既存の投稿が正しく分類されていない
**原因**: マイグレーションが正しく実行されていない可能性

**解決策**:
1. 以下のクエリで確認：
```sql
SELECT COUNT(*), user_type FROM forum_posts GROUP BY user_type;
```
2. もし結果がおかしい場合は、マイグレーションを再実行

### 問題: 親が子の投稿を見れてしまう
**原因**: フロントエンドが `userType` パラメータを渡していない可能性

**解決策**:
1. ブラウザの開発者ツールでNetworkタブを確認
2. APIリクエストに `userType` パラメータが含まれているか確認
3. 含まれていない場合は、`/forum/parent` または `/forum/child` からアクセスしているか確認

### 問題: コメントが投稿できない
**原因**: 異なるタイプの投稿にコメントしようとしている可能性

**解決策**:
1. ブラウザの開発者ツールのConsoleでエラーメッセージを確認
2. 投稿のURLが正しいフォーラムからのものか確認（例: 親なら `/forum/parent` から）

## 完了チェックリスト

- [ ] すべてのテストケースが完了
- [ ] データベースレベルでの検証が完了
- [ ] APIエンドポイントのテストが完了
- [ ] UIの検証が完了
- [ ] トラブルシューティングセクションを確認
- [ ] 問題がある場合は開発者に報告

## 成功基準

すべてのテストケースが合格すれば、フォーラムの親子分離機能は正常に動作しています。
