# パスワード忘れ機能

## 概要

ユーザーがパスワードを忘れてしまった場合に、メール経由でパスワードをリセットできる機能です。

## 機能説明

### 1. パスワード忘れページ (`/auth/forgot-password`)
- ユーザーがメールアドレスを入力
- 入力されたメールアドレスにパスワードリセットリンクを送信
- セキュリティ上、ユーザーが存在するかどうかは明かさない

### 2. パスワードリセットリンク
- Supabase Auth の `resetPasswordForEmail()` を使用
- ユーザーのメールに送信されたリンクをクリック
- `reset-password-confirm` ページにリダイレクト

### 3. パスワード変更ページ (`/auth/reset-password-confirm`)
- URLから取得したコードを使用してセッションを確立
- 新しいパスワードを入力
- パスワード強度チェック（最小8文字）
- パスワード確認入力による確認
- 成功後、ログインページにリダイレクト

## API エンドポイント

### POST `/api/auth/reset-password/request`

パスワードリセットリンクをメールで送信

**リクエスト：**
```json
{
  "email": "user@example.com"
}
```

**レスポンス（200）：**
```json
{
  "success": true,
  "message": "パスワードリセットリンクをメールアドレスに送信しました。メールボックスを確認してください。"
}
```

**エラーレスポンス（400）：**
```json
{
  "error": "メールアドレスが必要です"
}
```

### POST `/api/auth/reset-password/confirm`

パスワードリセットトークンを使用して新しいパスワードを設定

**リクエスト：**
```json
{
  "code": "reset_token_from_email",
  "password": "new_password"
}
```

**レスポンス（200）：**
```json
{
  "success": true,
  "message": "パスワードが正常にリセットされました。ログインしてください。"
}
```

**エラーレスポンス（400）：**
```json
{
  "error": "リセットリンクが無効または期限切れです"
}
```

## セキュリティ機能

### 1. パスワード強度チェック
- 最小8文字の長さが必須
- 確認入力フィールドでユーザー入力ミスを防止

### 2. トークン管理
- Supabase Auth が自動的にリセットトークンを管理
- トークンには有効期限が設定される（デフォルト：1時間）

### 3. ユーザープライバシー保護
- メールアドレスが存在するかどうかを明かさない
- どのメールアドレスでもリクエスト成功メッセージが返される

### 4. セッション管理
- `exchangeCodeForSession()` でトークンからセッションを作成
- 有効なセッションのみパスワード更新を許可

## ユーザーフロー

```
ログインページ
  ↓
「パスワードをお忘れですか？」リンククリック
  ↓
/auth/forgot-password ページ
  ↓
メールアドレス入力 → リセットリンク送信
  ↓
ユーザーのメールに届く
  ↓
メール内のリンククリック
  ↓
/auth/reset-password-confirm?code=xxx ページ
  ↓
新しいパスワード入力 → リセット完了
  ↓
/auth/login ページにリダイレクト
  ↓
新しいパスワードでログイン
```

## 設定

### 環境変数

`.env.local` に以下を設定

```
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

Supabase プロジェクトで以下を設定：

1. **Authentication** → **Email Templates**
2. **Reset Password** テンプレートを確認
3. リンクが `https://yourdomain.com/auth/reset-password-confirm` にリダイレクトするよう設定

## トラブルシューティング

### メールが届かない場合
- メール設定が正しいか確認（Supabase ダッシュボード）
- 迷惑メールフォルダを確認
- Supabase のメール送信状況を確認

### リセットリンク有効期限が切れた
- 「パスワードをお忘れですか？」ページから再度リクエスト
- デフォルト有効期限：1時間

### パスワード変更に失敗する場合
- パスワードが8文字以上か確認
- URLのコードが正しいか確認
- ブラウザ開発ツールでコンソールエラーを確認
