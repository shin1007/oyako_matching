# セキュリティサマリー - 掲示板編集・削除機能

## 実装されたセキュリティ機能

### 1. 認証と認可

#### APIレベルの保護
- **認証チェック**: すべてのエンドポイントでユーザー認証を確認
- **所有権確認**: 編集・削除操作前に著者本人であることを確認
- **エラーハンドリング**: 未認証の場合は401、権限がない場合は403を返す

```typescript
// 実装例（投稿の編集）
const { data: { user } } = await supabase.auth.getUser();
if (!user) {
  return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
}

const { data: post } = await supabase
  .from('forum_posts')
  .select('author_id')
  .eq('id', id)
  .single();

if (!post || post.author_id !== user.id) {
  return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
}
```

### 2. Row Level Security (RLS)

既存のRLSポリシーを使用してデータベースレベルで保護：

#### forum_posts テーブル
- **SELECT**: 承認済み投稿は全員、自分の投稿は常に閲覧可能
- **UPDATE**: 自分の投稿のみ更新可能
- **DELETE**: 自分の投稿のみ削除可能

#### forum_comments テーブル
- **SELECT**: 承認済みコメントは全員、自分のコメントは常に閲覧可能
- **UPDATE**: 自分のコメントのみ更新可能
- **DELETE**: 自分のコメントのみ削除可能

### 3. コンテンツモデレーション

#### OpenAI Moderation API
編集時に自動的にコンテンツをチェック：

```typescript
const moderation = await moderateContent(`${title} ${content}`);
if (moderation.flagged) {
  return NextResponse.json(
    { error: 'Content contains inappropriate material' },
    { status: 400 }
  );
}
```

**検出される不適切なコンテンツ:**
- 暴力的な表現
- 性的な内容
- ヘイトスピーチ
- 脅迫行為
- 自傷行為の助長

### 4. 入力検証

#### 必須フィールドの確認
```typescript
if (!title || !content) {
  return NextResponse.json(
    { error: 'Title and content are required' },
    { status: 400 }
  );
}
```

#### クライアント側の検証
- 空の入力は送信ボタンを無効化
- 編集中は他の操作を無効化

## セキュリティリスクの評価

### 低リスク
1. **XSS (Cross-Site Scripting)**
   - Reactが自動的にエスケープ処理を実施
   - `whitespace-pre-wrap`を使用してテキストとして表示

2. **CSRF (Cross-Site Request Forgery)**
   - Supabase認証トークンを使用
   - Same-Siteクッキー属性による保護

3. **SQL Injection**
   - Supabase ORMを使用してパラメータ化されたクエリ
   - RLSポリシーによる追加保護

### 実装済みの対策

1. **不正な削除の防止**
   - API側とRLS側の二重チェック
   - フロントエンドでの確認ダイアログ

2. **不適切なコンテンツの防止**
   - OpenAI Moderationによる自動検出
   - 編集時も同様のチェックを実施

3. **レート制限**
   - 現状未実装だが、将来的に検討すべき項目
   - Supabaseの組み込み機能で対応可能

## 検証結果

### 手動セキュリティテスト

#### ✅ 実施項目
1. **認証テスト**
   - 未認証ユーザーはAPI呼び出し時に401エラー
   - フロントエンドでログインページへリダイレクト

2. **認可テスト**
   - 他人の投稿を編集しようとすると403エラー
   - 他人のコメントを削除しようとすると403エラー
   - UI上は他人のコンテンツに編集・削除ボタンが表示されない

3. **コンテンツモデレーションテスト**
   - 不適切な内容を含む編集は拒否される
   - エラーメッセージが適切に表示される

4. **RLSテスト**
   - データベース直接クエリでも保護されることを確認
   - 他ユーザーのコンテンツは取得・更新・削除不可

## 既知の制限事項

1. **レート制限**
   - 現在は実装されていない
   - 悪意のあるユーザーが大量の編集・削除を実行可能

2. **監査ログ**
   - 編集・削除の履歴は保存されない
   - updated_atタイムスタンプのみ記録

3. **復元機能**
   - 削除は物理削除
   - 誤って削除したコンテンツは復元不可能

## 推奨される今後の改善

### 優先度: 高
1. **レート制限の実装**
   - API呼び出しの頻度制限
   - 特定時間内の編集回数制限

2. **監査ログ**
   - 編集・削除操作のログ記録
   - 管理者による確認機能

### 優先度: 中
1. **論理削除**
   - deleted_atカラムの追加
   - 削除済みコンテンツの保持と復元機能

2. **編集履歴**
   - 変更履歴の保存
   - ユーザーによる履歴の閲覧

### 優先度: 低
1. **自動バックアップ**
   - 定期的なデータベーススナップショット
   - ポイントインタイムリカバリ

2. **管理者機能**
   - 管理者による任意のコンテンツの編集・削除
   - 不適切なコンテンツの強制削除

## 結論

実装された編集・削除機能は、以下のセキュリティ対策により適切に保護されています：

1. **認証と認可**: 多層防御アプローチ（API + RLS）
2. **コンテンツモデレーション**: AI による自動検出
3. **入力検証**: クライアント側とサーバー側の両方で実施

現時点で重大なセキュリティ脆弱性は検出されていません。ただし、レート制限と監査ログの実装を推奨します。
