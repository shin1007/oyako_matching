# マッチング通知機能

## 概要
ダッシュボードにマッチング候補の通知を表示する機能です。生年月日の一致に基づいて、親ユーザーと子ユーザーのマッチング候補を自動的に検索し、表示します。

## ユーザー向け手動操作

### 前提条件
マッチング候補を表示するには、以下の情報を事前に登録する必要があります：

1. **本人確認の完了**
   - マイナンバーカードによる本人確認が必要です
   - ダッシュボードの「本人確認を行う」ボタンから実施

2. **プロフィール情報の登録**
   - ダッシュボード → 「プロフィール」から以下を登録：
     - 氏名（必須）
     - 生年月日（必須）
     - その他の任意情報

3. **親ユーザーの場合：探している子どもの情報を登録**
   - プロフィール編集画面の「探している子どもの情報」セクション
   - 以下の情報を登録：
     - 生年月日（必須）
     - 性別（任意、将来の拡張用）
     - 名前のひらがな・漢字（任意）
   - 最大5人まで登録可能

### 通知の見方

#### マッチング候補がある場合
- ダッシュボード上部に緑色の通知カードが表示されます
- 候補件数と最大5件の候補リストが表示されます
- 各候補には以下が表示されます：
  - 氏名
  - 生年月日
- 「すべて表示 →」リンクから詳細なマッチングページへ遷移できます

#### 必須データが未登録の場合
- ダッシュボード上部にオレンジ色の通知カードが表示されます
- 不足している情報が明示されます
- 「プロフィールを編集」ボタンからプロフィール編集ページへ遷移できます

## 技術仕様

### マッチングロジック

#### 親ユーザーの場合
1. `searching_children` テーブルに登録された各子どもの生年月日を取得
2. 同じ生年月日を持つ子ユーザーを `profiles` テーブルから検索
3. 重複を除外してマッチング候補として返す

#### 子ユーザーの場合
1. 自身の `profiles.birth_date` を取得
2. 同じ生年月日を `searching_children.birth_date` に持つ親ユーザーを検索
3. 親ユーザーのプロフィール情報を取得してマッチング候補として返す

### データベースクエリの最適化
- IN句を使用して複数の生年月日を一度に検索
- N+1クエリ問題を回避し、パフォーマンスを向上

### セキュリティ
- Row Level Security (RLS) ポリシーを考慮
- 必要最小限のカラムのみ取得
- 自分自身は候補から除外

## 現在の制限事項

### 性別フィールドについて
- 子ユーザーの性別フィールドが現時点では未整備
- 初期版では生年月日のみでマッチング判定を実施
- 親ユーザーの `searching_children.gender` は将来の拡張に備えて保持

### 今後の拡張予定
1. 子ユーザーの性別フィールド追加
2. 性別を含めたマッチング判定
3. より詳細なマッチング条件の追加
4. マッチング候補の優先順位付け

## 関連ファイル
- `lib/matching/candidates.ts` - マッチング候補検索ロジック
- `app/dashboard/page.tsx` - ダッシュボード表示ロジック
- `types/database.ts` - データベース型定義

## トラブルシューティング

### マッチング候補が表示されない
1. プロフィールに生年月日が登録されているか確認
2. 親ユーザーの場合、探している子どもの生年月日が登録されているか確認
3. 本人確認が完了しているか確認

### 通知カードが表示されない
1. 本人確認（マイナンバーカード認証）が完了しているか確認
2. ログインしているか確認
