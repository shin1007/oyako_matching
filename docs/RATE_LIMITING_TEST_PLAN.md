# レート制限機能 - テストプラン

## テストの目的

掲示板のスパム防止レート制限機能が正しく動作し、ユーザー体験を損なわないことを確認する。

## 前提条件

### 必須セットアップ

1. **データベースマイグレーション実行**
   ```bash
   supabase db push
   ```
   または、Supabaseダッシュボードから `supabase/migrations/019_rate_limits.sql` を実行

2. **アプリケーション起動**
   ```bash
   npm run dev
   ```

3. **テストユーザー準備**
   - 親アカウント（role='parent'）が必要
   - ログイン可能な状態

## テストケース

### 1. 投稿レート制限のテスト

#### 1.1 基本的な投稿レート制限（1分間に1投稿）

**手順:**
1. 親アカウントでログイン
2. `/forum/new` にアクセス
3. タイトルと内容を入力して投稿
4. 投稿成功を確認
5. すぐに `/forum/new` に再度アクセス
6. タイトルと内容を入力して投稿を試みる

**期待結果:**
- ❌ 2回目の投稿がエラーになる
- ✅ 「1分間の制限に達しました。次の投稿は X秒後 以降に可能です。」というメッセージが表示される
- ✅ カウントダウンタイマーが表示され、秒単位で減少する
- ✅ 投稿ボタンが無効化され、カウントダウンが表示される
- ✅ 60秒経過後、自動的にエラーメッセージとカウントダウンが消え、投稿可能になる

#### 1.2 時間制限（1時間に5投稿）

**手順:**
1. 1分間隔で5回投稿を行う（各投稿間に60秒以上待つ）
2. 5回目の投稿後、すぐに6回目の投稿を試みる

**期待結果:**
- ✅ 1-5回目の投稿は成功する
- ❌ 6回目の投稿がエラーになる
- ✅ 「1時間の制限に達しました」というメッセージが表示される
- ✅ カウントダウンタイマーが分単位で表示される

#### 1.3 日制限（1日に20投稿）

**手順:**
1. 自動テストスクリプトまたは手動で20回投稿
2. 21回目の投稿を試みる

**期待結果:**
- ✅ 1-20回目の投稿は成功する
- ❌ 21回目の投稿がエラーになる
- ✅ 「1日の制限に達しました」というメッセージが表示される

### 2. コメントレート制限のテスト

#### 2.1 基本的なコメントレート制限（1分間に3コメント）

**手順:**
1. 親アカウントでログイン
2. 任意の投稿の詳細ページ (`/forum/[id]`) にアクセス
3. 3つのコメントを連続して投稿
4. 4つ目のコメントを即座に投稿を試みる

**期待結果:**
- ✅ 1-3回目のコメントは成功する
- ❌ 4回目のコメントがエラーになる
- ✅ 「1分間の制限に達しました」というメッセージが表示される
- ✅ カウントダウンタイマーが表示される
- ✅ コメントフォームとボタンが無効化される

#### 2.2 同一投稿への連続コメント制限（30秒間隔）

**手順:**
1. 親アカウントでログイン
2. 投稿の詳細ページにアクセス
3. コメントを1つ投稿
4. 即座に同じ投稿に2つ目のコメントを投稿を試みる

**期待結果:**
- ✅ 1回目のコメントは成功する
- ❌ 30秒以内の2回目のコメントがエラーになる
- ✅ 「同じ投稿への連続コメントは30秒以上間隔を空けてください」というメッセージが表示される
- ✅ カウントダウンタイマーが30秒からカウントダウンする
- ✅ 30秒経過後、自動的に制限が解除される

#### 2.3 異なる投稿へのコメント

**手順:**
1. 投稿Aにコメント
2. 即座に投稿Bにコメント
3. 即座に投稿Cにコメント

**期待結果:**
- ✅ すべてのコメントが成功する（異なる投稿なので30秒制限は適用されない）
- ✅ ただし、1分間に3コメント制限は適用される

### 3. UI/UX のテスト

#### 3.1 カウントダウンタイマーの動作

**確認項目:**
- ✅ カウントダウンが1秒ごとに更新される
- ✅ 時間表示が適切（「X時間Y分後」「X分Y秒後」「X秒後」）
- ✅ カウントダウンが0になったらエラーメッセージが消える
- ✅ カウントダウンが0になったらボタンが有効になる

#### 3.2 ボタンとフォームの状態

**確認項目:**
- ✅ 制限中はボタンが無効化され、視覚的に区別できる（グレーアウト）
- ✅ 制限中はボタンのラベルがカウントダウンに変更される
- ✅ コメントフォームの場合、テキストエリアも無効化される
- ✅ マウスカーソルが `not-allowed` になる

#### 3.3 エラーメッセージの表示

**確認項目:**
- ✅ エラーメッセージが赤色の背景で目立つ
- ✅ メッセージが日本語で分かりやすい
- ✅ カウントダウンタイマーがメッセージと一緒に表示される

### 4. APIレスポンスのテスト

#### 4.1 レート制限エラーのレスポンス

**手順:**
1. ブラウザの開発者ツールを開く
2. レート制限に達するまで投稿/コメント
3. ネットワークタブでAPIレスポンスを確認

**期待結果:**
```json
{
  "error": "1分間の制限に達しました。次の投稿は X秒後 以降に可能です。",
  "retryAfter": "2024-01-18T12:34:56.789Z"
}
```
- ✅ ステータスコード: 429 Too Many Requests
- ✅ エラーメッセージが含まれる
- ✅ `retryAfter` フィールドに次の実行可能時刻が含まれる

### 5. データベース整合性のテスト

#### 5.1 rate_limits テーブルの確認

**手順:**
1. 投稿またはコメントを実行
2. Supabase ダッシュボードまたはSQL クライアントで確認

```sql
SELECT * FROM public.rate_limits 
WHERE user_id = 'your-user-id' 
ORDER BY action_timestamp DESC 
LIMIT 10;
```

**期待結果:**
- ✅ 各アクション後にレコードが作成される
- ✅ `user_id` が正しい
- ✅ `action_type` が 'post' または 'comment'
- ✅ コメントの場合、`post_id` が設定される
- ✅ `action_timestamp` が現在時刻に近い

#### 5.2 クリーンアップ関数のテスト

**手順:**
```sql
-- 古いレコードを作成（テスト用）
INSERT INTO public.rate_limits (user_id, action_type, action_timestamp)
VALUES ('test-user-id', 'post', NOW() - INTERVAL '2 days');

-- レコード数を確認
SELECT COUNT(*) FROM public.rate_limits WHERE user_id = 'test-user-id';

-- クリーンアップ実行
SELECT clean_old_rate_limits();

-- レコード数を再確認
SELECT COUNT(*) FROM public.rate_limits WHERE user_id = 'test-user-id';
```

**期待結果:**
- ✅ 1日以上前のレコードが削除される
- ✅ 新しいレコードは残る

### 6. エッジケースのテスト

#### 6.1 データベースエラー時の動作

**手順:**
1. Supabase の接続を一時的に切断（ネットワークを切断など）
2. 投稿またはコメントを試みる

**期待結果:**
- ✅ エラーメッセージが表示される
- ✅ 「現在、一時的にサービスが混み合っています」というメッセージ
- ✅ セキュリティ優先でアクションがブロックされる

#### 6.2 ページリロード時の状態

**手順:**
1. レート制限に達する
2. カウントダウン中にページをリロード

**期待結果:**
- ✅ リロード後も制限は有効（サーバーサイドで管理）
- ✅ ただし、クライアント側のカウントダウンはリセットされる（APIエラーで再表示）

#### 6.3 複数タブでの動作

**手順:**
1. 同じアカウントで2つのタブを開く
2. タブAで投稿
3. タブBですぐに投稿を試みる

**期待結果:**
- ✅ タブBでレート制限エラーが発生する
- ✅ サーバーサイドの制限が正しく機能する

### 7. パフォーマンステスト

#### 7.1 レスポンス時間の確認

**手順:**
1. ブラウザの開発者ツールでネットワークタブを開く
2. 投稿またはコメントを実行
3. APIレスポンス時間を確認

**期待結果:**
- ✅ レート制限チェックによるオーバーヘッドが最小限（50ms以下が理想）
- ✅ 通常の投稿/コメントと比較して大きな遅延がない

## テスト環境

### 推奨環境
- **ブラウザ**: Chrome, Firefox, Safari, Edge の最新版
- **デバイス**: デスクトップ、タブレット、スマートフォン
- **ネットワーク**: 高速、低速（throttling）

### 必要なツール
- ブラウザの開発者ツール
- Supabase ダッシュボードまたはSQL クライアント
- （オプション）Postman や curl などの API テストツール

## バグレポートのフォーマット

バグを見つけた場合は以下の情報を含めてレポートしてください：

```
### 概要
[バグの簡潔な説明]

### 再現手順
1. [ステップ1]
2. [ステップ2]
3. [ステップ3]

### 期待される動作
[期待される結果]

### 実際の動作
[実際に起きた結果]

### 環境
- ブラウザ: [名前とバージョン]
- OS: [Windows/Mac/Linux + バージョン]
- 画面サイズ: [解像度]

### スクリーンショット
[可能であれば添付]

### エラーログ
[ブラウザコンソールのエラー]
```

## テスト完了チェックリスト

- [ ] 投稿の1分間制限が動作する
- [ ] 投稿の1時間制限が動作する
- [ ] 投稿の1日制限が動作する
- [ ] コメントの1分間制限が動作する
- [ ] コメントの1時間制限が動作する
- [ ] 同一投稿への30秒制限が動作する
- [ ] カウントダウンタイマーが正確に動作する
- [ ] UIが適切に無効化/有効化される
- [ ] エラーメッセージが分かりやすい
- [ ] APIレスポンスが正しい形式
- [ ] データベースレコードが正しく作成される
- [ ] エッジケースが適切に処理される
- [ ] パフォーマンスが許容範囲内
- [ ] 複数ブラウザで動作する
- [ ] モバイルデバイスで動作する

## まとめ

すべてのテストケースをパスすれば、レート制限機能は本番環境にデプロイ可能です。
