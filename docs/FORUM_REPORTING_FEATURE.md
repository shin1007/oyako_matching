# 掲示板通報機能 実装ドキュメント

## ユーザーが実行すべき操作

### 1. データベースマイグレーションの適用

この機能を有効にするには、Supabaseでデータベースマイグレーションを適用する必要があります。

```bash
# Supabaseプロジェクトにログイン
supabase login

# マイグレーションを適用
supabase db push
```

または、Supabase Dashboard から以下のSQLファイルの内容を実行してください：
- `supabase/migrations/018_forum_reports.sql`

### 2. 環境変数の確認

通報機能は既存のSupabase設定を使用しますので、追加の環境変数は不要です。
ただし、以下の環境変数が正しく設定されていることを確認してください：

- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- `SUPABASE_SERVICE_ROLE_KEY`

## 実装内容

### 機能概要

ユーザーが不適切な投稿やコメントを通報できる機能を実装しました。

### データベース設計

#### forum_reports テーブル

| カラム名 | 型 | 説明 |
|---------|---|------|
| id | UUID | 主キー |
| reporter_id | UUID | 通報者のユーザーID |
| reported_content_type | TEXT | 通報対象の種類（'post' または 'comment'） |
| reported_content_id | UUID | 通報対象のID |
| report_reason | TEXT | 通報理由（'spam', 'harassment', 'personal_info', 'inappropriate', 'other'） |
| report_details | TEXT | 詳細説明（任意） |
| status | TEXT | ステータス（'pending', 'reviewed', 'resolved', 'dismissed'） |
| reviewed_by | UUID | レビューした管理者のID（将来の機能） |
| reviewed_at | TIMESTAMP | レビュー日時（将来の機能） |
| created_at | TIMESTAMP | 通報作成日時 |

#### 通報理由の種類

1. **スパム** - 宣伝や勧誘など、関連性のないコンテンツ
2. **誹謗中傷・ハラスメント** - 他のユーザーを傷つける言動や嫌がらせ
3. **個人情報の掲載** - 許可なく個人情報を公開している
4. **不適切なコンテンツ** - 暴力的、性的、または違法なコンテンツ
5. **その他** - 上記に当てはまらない理由

### セキュリティ機能

1. **通報者の匿名性保護**
   - RLSポリシーにより、通報者は自分の通報のみ閲覧可能
   - 他のユーザーは通報内容を見ることができません

2. **重複通報の防止**
   - 同じユーザーが同じコンテンツを複数回通報することはできません
   - データベースレベルでユニーク制約を設定

3. **権限管理**
   - 通報の作成：認証済みユーザー
   - 通報の閲覧：通報者本人のみ
   - 通報ステータスの更新：RLSポリシーで制限（将来の管理者機能用）

### API エンドポイント

#### POST /api/forum/reports
通報を作成

**リクエストボディ:**
```json
{
  "reported_content_type": "post",
  "reported_content_id": "uuid",
  "report_reason": "spam",
  "report_details": "詳細説明（任意）"
}
```

#### GET /api/forum/reports
自分の通報一覧を取得

**クエリパラメータ:**
- `status` (任意) - ステータスでフィルタ
- `content_type` (任意) - コンテンツタイプでフィルタ
- `page` (任意) - ページ番号（デフォルト: 1）

#### GET /api/forum/reports/[id]
通報の詳細を取得（自分の通報のみ）

#### PUT /api/forum/reports/[id]
通報ステータスを更新（将来の管理者機能用）

**注意:** 現在、このエンドポイントはRLSポリシーにより一般ユーザーからの更新が制限されています。

### UI実装

#### 通報ボタン

- 投稿詳細ページの投稿本文下部に配置
- 各コメントの下部に配置
- 自分の投稿/コメントには表示されません
- 既に通報済みの場合は「✓ 通報済み」と表示され、ボタンが無効化されます

#### 通報モーダル

通報ボタンをクリックすると表示されるモーダル：

1. 通報対象のプレビュー表示
2. 通報理由の選択（ラジオボタン）
3. 詳細説明の入力欄（任意、「その他」選択時は必須）
4. 通報完了時の成功メッセージ

### データベース関数

#### get_report_count(content_type, content_id)
特定のコンテンツに対する通報数を取得

#### has_user_reported(user_id, content_type, content_id)
ユーザーが既に通報済みかチェック

## 今後の拡張機能

### 管理者ダッシュボード（推奨）

1. **通報一覧画面**
   - すべての通報を閲覧
   - ステータスでフィルタリング
   - コンテンツタイプでフィルタリング

2. **通報詳細画面**
   - 通報内容の確認
   - 通報対象のコンテンツ表示
   - ステータス変更（reviewed, resolved, dismissed）

3. **自動アクション**
   - 一定数の通報があった投稿/コメントを自動的に非表示
   - 管理者への通知機能

4. **統計情報**
   - 通報数の推移
   - 理由別の分類
   - 対応状況

### 通報者への通知

通報の処理結果を通報者に通知する機能（別Issueとして実装推奨）

## 使用方法

### ユーザー向け

1. 不適切な投稿またはコメントを見つけた場合、「🚨 通報」ボタンをクリック
2. 通報理由を選択
3. 必要に応じて詳細説明を入力
4. 「通報する」ボタンをクリック
5. 通報が完了すると「✓ 通報済み」と表示されます

### 開発者向け

通報データを確認する場合は、Supabase Dashboardから `forum_reports` テーブルを参照してください。

## トラブルシューティング

### 通報ボタンが表示されない

- ログインしているか確認
- 自分の投稿/コメントには通報ボタンは表示されません

### 「すでにこのコンテンツを通報しています」エラー

- 同じコンテンツは一度しか通報できません
- これは重複通報を防ぐための仕様です

### 通報が送信できない

- ネットワーク接続を確認
- ブラウザのコンソールでエラーメッセージを確認
- 通報対象のコンテンツが削除されていないか確認

## テスト手順

1. **通報機能のテスト**
   ```
   1. ユーザーAでログイン
   2. 掲示板の投稿詳細ページを開く
   3. 「🚨 通報」ボタンをクリック
   4. 通報理由を選択して送信
   5. 「✓ 通報済み」と表示されることを確認
   6. 同じ投稿を再度通報しようとすると、ボタンが無効化されていることを確認
   ```

2. **重複通報防止のテスト**
   ```
   1. 既に通報済みの投稿を開く
   2. 「✓ 通報済み」と表示され、ボタンが無効化されていることを確認
   3. 別のコメントは通報可能であることを確認
   ```

3. **セキュリティテスト**
   ```
   1. Supabase Dashboardで forum_reports テーブルを確認
   2. RLSポリシーが有効であることを確認
   3. 別のユーザーの通報を閲覧できないことを確認
   ```

## 参考リンク

- [Supabase RLS ドキュメント](https://supabase.com/docs/guides/auth/row-level-security)
- [Next.js API Routes](https://nextjs.org/docs/app/building-your-application/routing/route-handlers)
