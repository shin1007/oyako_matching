# 掲示板の編集・削除機能 実装完了

## 実装内容

### 1. APIエンドポイント

#### 投稿の編集・削除
- **PATCH /api/forum/posts/[id]** - 投稿の編集（モデレーションチェック含む）
- **DELETE /api/forum/posts/[id]** - 投稿の削除

#### コメントの編集・削除
- **PATCH /api/forum/comments/[id]** - コメントの編集（モデレーションチェック含む）
- **DELETE /api/forum/comments/[id]** - コメントの削除

### 2. セキュリティ機能

#### 認証・認可
- 著者本人のみが編集・削除可能
- RLSポリシーによるデータベースレベルの保護（既存）
- APIレベルでの所有権確認

#### コンテンツモデレーション
- 編集時にOpenAI Moderation APIでコンテンツチェック
- 不適切な内容が検出された場合は更新を拒否

### 3. UIコンポーネント

#### 投稿の編集・削除UI
- **編集ボタン** - 投稿者のみに表示、クリックで編集モードに切り替え
- **編集フォーム** - タイトルと内容を編集可能、保存・キャンセルボタン付き
- **削除ボタン** - 投稿者のみに表示
- **削除確認ダイアログ** - 削除前に確認メッセージを表示
- **編集済みバッジ** - updated_atとcreated_atが異なる場合に「編集済み」表示

#### コメントの編集・削除UI
- **編集ボタン** - コメント投稿者のみに表示
- **インライン編集フォーム** - コメント欄にそのまま表示
- **削除ボタン** - コメント投稿者のみに表示
- **削除確認ダイアログ** - 削除前に確認メッセージを表示
- **編集済みバッジ** - updated_atとcreated_atが異なる場合に「編集済み」表示

### 4. ユーザーフロー

#### 投稿の編集
1. 投稿詳細ページで「編集」ボタンをクリック
2. 編集フォームが表示される（タイトル・内容）
3. 内容を編集して「保存」をクリック
4. OpenAI Moderationチェックが実行される
5. 問題なければ更新され、編集モードが解除される
6. 「編集済み」バッジが表示される

#### 投稿の削除
1. 投稿詳細ページで「削除」ボタンをクリック
2. 削除確認ダイアログが表示される
3. 「削除」をクリックで削除実行
4. 削除成功後、掲示板トップページへリダイレクト

#### コメントの編集
1. コメント表示部分で「編集」ボタンをクリック
2. インライン編集フォームが表示される
3. 内容を編集して「保存」をクリック
4. OpenAI Moderationチェックが実行される
5. 問題なければ更新され、表示モードに戻る
6. 「編集済み」バッジが表示される

#### コメントの削除
1. コメント表示部分で「削除」ボタンをクリック
2. 削除確認ダイアログが表示される
3. 「削除」をクリックで削除実行
4. コメントがリストから削除される

## 技術的な詳細

### ファイル構成

```
app/
├── api/
│   └── forum/
│       ├── posts/
│       │   └── [id]/
│       │       └── route.ts         # 投稿の編集・削除API（既存更新）
│       └── comments/
│           └── [id]/
│               └── route.ts         # コメントの編集・削除API（新規作成）
└── forum/
    └── [id]/
        └── page.tsx                 # 投稿詳細ページ（編集・削除UI追加）
```

### データベーススキーマ

既存のRLSポリシーを使用:
- `forum_posts.updated_at` - 編集時に自動更新
- `forum_comments.updated_at` - 編集時に自動更新

### 状態管理

React Hooksを使用した状態管理:
- `editingPostId` - 編集中の投稿ID
- `editingCommentId` - 編集中のコメントID
- `showDeletePostDialog` - 投稿削除ダイアログの表示状態
- `showDeleteCommentDialog` - コメント削除ダイアログの表示状態（コメントID）

## テスト・検証

### 手動テスト項目

- [ ] 投稿の編集（自分の投稿）
- [ ] 投稿の編集（他人の投稿 - 失敗するべき）
- [ ] 投稿の削除（自分の投稿）
- [ ] 投稿の削除（他人の投稿 - 失敗するべき）
- [ ] コメントの編集（自分のコメント）
- [ ] コメントの編集（他人のコメント - 失敗するべき）
- [ ] コメントの削除（自分のコメント）
- [ ] コメントの削除（他人のコメント - 失敗するべき）
- [ ] 不適切な内容を含む編集（Moderationチェック）
- [ ] 編集済みバッジの表示確認
- [ ] 削除確認ダイアログの動作確認

### セキュリティテスト項目

- [ ] RLSポリシーが正しく機能しているか
- [ ] APIレベルでの所有権確認が機能しているか
- [ ] OpenAI Moderationチェックが機能しているか

## 既知の制限事項

- 削除は物理削除（論理削除ではない）
- 編集履歴は保存されない（updated_atのみ）
- 一度削除したコンテンツは復元不可能

## 今後の改善案

1. **論理削除の実装** - `deleted_at`カラムを追加し、削除したコンテンツを非表示にするが保持する
2. **編集履歴の保存** - `forum_post_history`テーブルを作成し、編集前の内容を保存
3. **編集回数の制限** - 過度な編集を防ぐため、編集回数に制限を設ける
4. **通知機能** - 投稿やコメントが編集・削除された場合に関係者に通知
5. **管理者機能** - 管理者が任意の投稿・コメントを編集・削除できる機能
