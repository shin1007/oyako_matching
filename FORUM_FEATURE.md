# ピアサポート掲示板機能 - 機能仕様

## 概要

親同士が情報交換や相談をするための掲示板機能。親子断絶や再会に関する経験や知識を共有し、互いにサポートし合うコミュニティを提供します。

## 対象ユーザー

- **投稿・コメント**: 親アカウントのみ
- **閲覧**: すべてのユーザー（親・子ども）

## データベース設計

### forum_categories（カテゴリ）
```sql
- id: UUID
- name: TEXT（カテゴリ名）
- description: TEXT（説明）
- icon: TEXT（絵文字アイコン）
- order_index: INTEGER（表示順）
```

**デフォルトカテゴリ：**
1. 💬 一般相談 - 親子関係や再会についての一般的な相談
2. ⚖️ 法律・手続き - 法律相談や手続きに関する情報交換
3. ❤️ 心のケア - メンタルヘルスや感情面のサポート
4. 🌟 成功体験 - 再会の成功事例やポジティブな体験の共有
5. ❓ 質問・回答 - 疑問や質問に答え合うコーナー

### forum_posts（投稿）
```sql
- id: UUID
- category_id: UUID（カテゴリID、nullable）
- author_id: UUID（投稿者ID）
- title: TEXT（タイトル）
- content: TEXT（本文）
- is_pinned: BOOLEAN（ピン留め）
- is_locked: BOOLEAN（ロック）
- view_count: INTEGER（閲覧数）
- moderation_status: TEXT（承認状態）
- created_at: TIMESTAMP
- updated_at: TIMESTAMP
```

### forum_comments（コメント）
```sql
- id: UUID
- post_id: UUID（投稿ID）
- author_id: UUID（コメント者ID）
- content: TEXT（内容）
- moderation_status: TEXT（承認状態）
- created_at: TIMESTAMP
- updated_at: TIMESTAMP
```

## 機能詳細

### 1. 投稿一覧（/forum）

**表示内容：**
- カテゴリフィルター（タブ形式）
- 投稿一覧（新着順、ピン留め優先）
- 各投稿の情報：
  - タイトル
  - 本文プレビュー（2行）
  - 投稿者名
  - カテゴリバッジ
  - コメント数
  - 閲覧数
  - 投稿日時

**機能：**
- カテゴリでフィルタリング
- 新規投稿ボタン（親のみ表示）
- 各投稿をクリックで詳細へ

**UI例：**
```
┌─────────────────────────────────────────────┐
│ ピアサポート掲示板      [新規投稿]         │
├─────────────────────────────────────────────┤
│ [すべて] [💬一般相談] [⚖️法律] [❤️心のケア]│
│ [🌟成功体験] [❓Q&A]                        │
├─────────────────────────────────────────────┤
│ ┌─────────────────────────────────────┐    │
│ │📌ピン留め  💬一般相談                │    │
│ │ 初めての再会、どう準備すれば？      │    │
│ │ 来週初めて子どもと会えることに...   │    │
│ │ 👤田中太郎  💬15件  👁️234  🕒3時間前 │    │
│ └─────────────────────────────────────┘    │
│                                             │
│ ┌─────────────────────────────────────┐    │
│ │⚖️法律・手続き                       │    │
│ │ 面会交流調停について教えてください  │    │
│ │ 現在、面会交流の調停中です...       │    │
│ │ 👤佐藤花子  💬8件  👁️156  🕒1日前   │    │
│ └─────────────────────────────────────┘    │
└─────────────────────────────────────────────┘
```

### 2. 新規投稿（/forum/new）

**入力項目：**
- カテゴリ（選択式、任意）
- タイトル（必須、最大200文字）
- 本文（必須）

**処理フロー：**
1. 入力内容の検証
2. OpenAI Moderation APIでコンテンツチェック
3. 不適切な内容の場合はエラー表示
4. 問題なければデータベースに保存
5. 投稿詳細ページへリダイレクト

**注意事項表示：**
- 個人情報（住所、電話番号など）は投稿しない
- 誹謗中傷は禁止
- 不適切な内容は自動削除される可能性

**UI例：**
```
┌─────────────────────────────────────────────┐
│ 新規投稿                                    │
├─────────────────────────────────────────────┤
│ カテゴリ: [選択▼]                           │
│                                             │
│ タイトル: [___________________________]     │
│                                             │
│ 内容:                                       │
│ [                                      ]    │
│ [                                      ]    │
│ [                                      ]    │
│                                             │
│ ⚠️ 注意事項                                 │
│ • 個人情報は投稿しないでください            │
│ • 誹謗中傷は禁止です                        │
│                                             │
│ [投稿する]  [キャンセル]                    │
└─────────────────────────────────────────────┘
```

### 3. 投稿詳細（/forum/[id]）

**表示内容：**
- 投稿本文（全文）
- 投稿者情報
- カテゴリバッジ
- 閲覧数
- 投稿日時
- コメント一覧
- コメント投稿フォーム（親のみ）

**機能：**
- 閲覧数の自動カウント
- コメント投稿
- コメントの表示（時系列順）

**UI例：**
```
┌─────────────────────────────────────────────┐
│ 📌ピン留め  💬一般相談                       │
├─────────────────────────────────────────────┤
│ 初めての再会、どう準備すれば？              │
│                                             │
│ 👤田中太郎  👁️234回  🕒2024/01/15 10:30    │
│                                             │
│ 来週初めて子どもと会えることになりました。  │
│ 3年ぶりの再会で、どう接したらいいか...     │
│ （本文続く）                                │
├─────────────────────────────────────────────┤
│ コメント (15)                               │
│                                             │
│ ┌─────────────────────────────────────┐    │
│ │ 佐藤花子  🕒2024/01/15 11:00        │    │
│ │ おめでとうございます！私の経験では...│    │
│ └─────────────────────────────────────┘    │
│                                             │
│ ┌─────────────────────────────────────┐    │
│ │ 鈴木一郎  🕒2024/01/15 12:30        │    │
│ │ 焦らずゆっくりと関係を...           │    │
│ └─────────────────────────────────────┘    │
│                                             │
│ [コメントを入力...]                         │
│ [コメントする]                              │
└─────────────────────────────────────────────┘
```

## API エンドポイント

### GET /api/forum/categories
カテゴリ一覧を取得

**レスポンス：**
```json
{
  "categories": [
    {
      "id": "uuid",
      "name": "一般相談",
      "description": "...",
      "icon": "💬",
      "order_index": 1
    }
  ]
}
```

### GET /api/forum/posts
投稿一覧を取得

**クエリパラメータ：**
- `category_id`: カテゴリでフィルター（任意）
- `page`: ページ番号（デフォルト1）

**レスポンス：**
```json
{
  "posts": [...],
  "pagination": {
    "page": 1,
    "perPage": 20,
    "total": 45,
    "totalPages": 3
  }
}
```

### POST /api/forum/posts
新規投稿を作成

**リクエストボディ：**
```json
{
  "title": "タイトル",
  "content": "本文",
  "category_id": "uuid"
}
```

**処理：**
1. 認証チェック（親のみ）
2. コンテンツモデレーション
3. データベースに保存

### GET /api/forum/posts/[id]
投稿詳細を取得

**レスポンス：**
```json
{
  "post": {...},
  "comments": [...]
}
```

### POST /api/forum/comments
コメントを作成

**リクエストボディ：**
```json
{
  "post_id": "uuid",
  "content": "コメント内容"
}
```

## セキュリティ

### Row Level Security (RLS)

**forum_categories:**
- 全員が閲覧可能

**forum_posts:**
- 閲覧: 承認済み投稿は全員、自分の投稿は常に閲覧可能
- 作成: 親のみ
- 更新: 自分の投稿のみ
- 削除: 自分の投稿のみ

**forum_comments:**
- 閲覧: 承認済みコメントは全員、自分のコメントは常に閲覧可能
- 作成: 親のみ
- 更新: 自分のコメントのみ
- 削除: 自分のコメントのみ

### コンテンツモデレーション

**自動モデレーション（OpenAI）：**
- 投稿・コメント作成時に自動実行
- 不適切な内容を検出
  - 暴力的な表現
  - 性的な内容
  - ヘイトスピーチ
  - 個人情報
- 検出された場合は投稿を拒否

**手動モデレーション：**
- `moderation_status`フィールドで管理
- `pending`: 承認待ち
- `approved`: 承認済み
- `rejected`: 拒否

## 今後の拡張案

1. **通知機能**
   - 自分の投稿にコメントがついたら通知
   - メンション機能（@username）

2. **検索機能**
   - タイトル・本文の全文検索
   - タグ機能

3. **リアクション機能**
   - いいね、参考になった、共感など

4. **画像添付**
   - 投稿に画像を添付可能

5. **プライベートメッセージ**
   - 掲示板から1対1のDMへ移行

6. **ベストアンサー**
   - 質問投稿でベストアンサーを選択

7. **レポート機能**
   - 不適切な投稿を通報

## 使用方法

### 親ユーザーの場合

1. ダッシュボードから「ピアサポート掲示板」をクリック
2. カテゴリを選択して投稿を閲覧
3. 「新規投稿」ボタンから投稿作成
4. 他の投稿にコメントして交流

### 子ユーザーの場合

1. ダッシュボードから「ピアサポート掲示板」をクリック
2. カテゴリを選択して投稿を閲覧
3. 親の経験や情報を参考にする
4. （投稿・コメントは不可）

## まとめ

ピアサポート掲示板機能により、親同士が経験や知識を共有し、互いに支え合うことができます。AIによる自動モデレーションとRLSによるセキュリティで、安全なコミュニティ運営を実現しています。
